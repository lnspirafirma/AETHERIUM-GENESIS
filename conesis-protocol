import time
import hashlib
import json
import logging
from enum import Enum
from typing import Dict, Any, Optional
from dataclasses import dataclass, asdict

# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Logger
logger = logging.getLogger("ConesisProtocol")

class ConesisOpCode(Enum):
    """à¸£à¸«à¸±à¸ªà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸¡à¸²à¸•à¸£à¸à¸²à¸™ (Operation Codes)"""
    HELLO = "HELLO"           # à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­
    WELCOME = "WELCOME"       # à¸•à¸­à¸šà¸£à¸±à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­
    HEARTBEAT = "HEARTBEAT"   # à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸
    DATA_SYNC = "DATA_SYNC"   # à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›
    CONSENSUS = "CONSENSUS"   # à¸‚à¸­à¸à¸²à¸£à¸¢à¸·à¸™à¸¢à¸±à¸™à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
    ERROR = "ERROR"           # à¹à¸ˆà¹‰à¸‡à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”

@dataclass
class ConesisPacket:
    """à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸‚à¸­à¸‡à¹à¸à¹‡à¸à¹€à¸à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Data Structure)"""
    version: str
    op_code: str
    sender_id: str
    target_id: str
    timestamp: float
    payload: Dict[str, Any]
    signature: str = "" # Hash signature

    def to_json(self) -> str:
        return json.dumps(asdict(self), sort_keys=True)

class ConesisProtocol:
    """
    Conesis Protocol Handler
    à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸à¸£à¸°à¹€à¸šà¸µà¸¢à¸š à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸š Aetherium
    """
    VERSION = "1.0.0-GENESIS"

    @staticmethod
    def create_packet(sender_id: str, target_id: str, op_code: ConesisOpCode, payload: Dict[str, Any]) -> ConesisPacket:
        """à¸ªà¸£à¹‰à¸²à¸‡à¹à¸à¹‡à¸à¹€à¸à¹‡à¸•à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸à¸£à¹‰à¸­à¸¡à¸›à¸£à¸°à¸—à¸±à¸šà¸•à¸£à¸²à¹€à¸§à¸¥à¸²à¹à¸¥à¸°à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™"""
        packet = ConesisPacket(
            version=ConesisProtocol.VERSION,
            op_code=op_code.value,
            sender_id=sender_id,
            target_id=target_id,
            timestamp=time.time(),
            payload=payload
        )
        packet.signature = ConesisProtocol._generate_signature(packet)
        return packet

    @staticmethod
    def validate_packet(packet_data: Dict[str, Any]) -> bool:
        """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¹à¸à¹‡à¸à¹€à¸à¹‡à¸• (Integrity Check)"""
        try:
            # à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸² Object à¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
            packet = ConesisPacket(**packet_data)
            
            # 1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Version
            if packet.version != ConesisProtocol.VERSION:
                logger.warning(f"Protocol Mismatch: {packet.version} vs {ConesisProtocol.VERSION}")
                return False

            # 2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Signature (Tamper Evidence)
            expected_sig = ConesisProtocol._generate_signature(packet)
            if packet.signature != expected_sig:
                logger.error("Invalid Signature! Data might be tampered.")
                return False

            return True
        except Exception as e:
            logger.error(f"Validation Error: {e}")
            return False

    @staticmethod
    def _generate_signature(packet: ConesisPacket) -> str:
        """à¸ªà¸£à¹‰à¸²à¸‡ Signature à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ Packet (à¹„à¸¡à¹ˆà¸£à¸§à¸¡ Signature à¹€à¸”à¸´à¸¡)"""
        # à¸ªà¸£à¹‰à¸²à¸‡ String à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸à¹€à¸à¸·à¹ˆà¸­à¸™à¸³à¹„à¸› Hash
        raw_data = f"{packet.version}{packet.op_code}{packet.sender_id}{packet.timestamp}{json.dumps(packet.payload, sort_keys=True)}"
        return hashlib.sha256(raw_data.encode('utf-8')).hexdigest()

# --- à¸ªà¹ˆà¸§à¸™à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™ (Integration Test Mock) ---
if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    # 1. à¸ˆà¸³à¸¥à¸­à¸‡ Agent A à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸‡à¸«à¸² Agent B
    agent_a = "Agent-Alpha"
    agent_b = "Agent-Beta"
    
    payload_data = {"command": "update_knowledge", "vector_id": 101}
    
    print(f"ğŸ“¡ [A] Creating Packet...")
    packet = ConesisProtocol.create_packet(
        sender_id=agent_a,
        target_id=agent_b,
        op_code=ConesisOpCode.DATA_SYNC,
        payload=payload_data
    )
    
    print(f"ğŸ“¦ Packet Generated: {packet.to_json()}")
    
    # 2. à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Serialize -> Deserialize)
    received_data = json.loads(packet.to_json())
    
    # 3. Agent B à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
    print(f"\nğŸ›¡ï¸ [B] Validating Packet...")
    is_valid = ConesisProtocol.validate_packet(received_data)
    print(f"Result: {'âœ… Valid' if is_valid else 'âŒ Invalid'}")

    # 4. à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸›à¸¥à¸­à¸¡à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Tampering Test)
    print(f"\nğŸ•µï¸ [Hacker] Trying to modify payload...")
    received_data['payload']['vector_id'] = 999 # à¹à¸­à¸šà¹à¸à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    
    is_valid_tampered = ConesisProtocol.validate_packet(received_data)
    print(f"Result: {'âœ… Valid' if is_valid_tampered else 'âŒ Invalid (Tamper Detected)'}")

